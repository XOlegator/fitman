(function(e,D){var y,H=e.IDBKeyRange||e.webkitIDBKeyRange,E=Object.prototype.hasOwnProperty,I=function(b){return b},K=function(b,e){var g=this,f=!1;this.add=function(d){if(f)throw"Database has been closed";for(var a=[],k=0,c=0;c<arguments.length-1;c++)if(Array.isArray(arguments[c+1]))for(var m=0;m<arguments[c+1].length;m++)a[k]=arguments[c+1][m],k++;else a[k]=arguments[c+1],k++;var h=b.transaction(d,"readwrite"),F=h.objectStore(d);return new Promise(function(b,c){a.forEach(function(a){var b;a.item&&
a.key?(b=a.key,a=a.item,b=F.add(a,b)):b=F.add(a);b.onsuccess=function(b){b=b.target;var c=b.source.keyPath;null===c&&(c="__id__");Object.defineProperty(a,c,{value:b.result,enumerable:!0})}});h.oncomplete=function(){b(a,g)};h.onerror=function(a){c(a)};h.onabort=function(a){c(a)}})};this.update=function(d){if(f)throw"Database has been closed";for(var a=[],k=0;k<arguments.length-1;k++)a[k]=arguments[k+1];var c=b.transaction(d,"readwrite"),m=c.objectStore(d);return new Promise(function(b,d){a.forEach(function(a){if(a.item&&
a.key){var b=a.key;a=a.item;a=m.put(a,b)}else a=m.put(a);a.onsuccess=function(a){}});c.oncomplete=function(){b(a,g)};c.onerror=function(a){d(a)};c.onabort=function(a){d(a)}})};this.remove=function(d,a){if(f)throw"Database has been closed";var k=b.transaction(d,"readwrite"),c=k.objectStore(d);return new Promise(function(b,d){c["delete"](a);k.oncomplete=function(){b(a)};k.onerror=function(a){d(a)}})};this.clear=function(d){if(f)throw"Database has been closed";var a=b.transaction(d,"readwrite");a.objectStore(d).clear();
return new Promise(function(b,c){a.oncomplete=function(){b()};a.onerror=function(a){c(a)}})};this.close=function(){if(f)throw"Database has been closed";b.close();f=!0;delete A[e]};this.get=function(d,a){if(f)throw"Database has been closed";var k=b.transaction(d),c=k.objectStore(d).get(a);return new Promise(function(a,b){c.onsuccess=function(b){a(b.target.result)};k.onerror=function(a){b(a)}})};this.query=function(d,a){if(f)throw"Database has been closed";return new J(d,b,a)};this.count=function(d,
a){if(f)throw"Database has been closed";b.transaction(d).objectStore(d)};for(var n=0,u=b.objectStoreNames.length;n<u;n++)(function(b){g[b]={};for(var a in g)E.call(g,a)&&"close"!==a&&(g[b][a]=function(a){return function(){var c=[b].concat([].slice.call(arguments,0));return g[a].apply(g,c)}}(a))})(b.objectStoreNames[n])},J=function(b,e,g){var f=this,n=!1,u=function(a,d,c,m,h,f,u){var z=e.transaction(b,n?"readwrite":"readonly"),l=z.objectStore(b),l=g?l.index(g):l,B=[];a=[a?H[a].apply(null,d):null];
h=h?h:null;f=f?f:[];var q=0;"count"!==c&&a.push(m||"next");var r=n?Object.keys(n):!1,s=function(a){for(var b=0;b<r.length;b++){var c=r[b],d=n[c];d instanceof Function&&(d=d(a));a[c]=d}return a};l[c].apply(l,a).onsuccess=function(a){a=a.target.result;if("number"===typeof a)B=a;else if(a)if(null!==h&&h[0]>q)q=h[0],a.advance(h[0]);else if(!(null!==h&&q>=h[0]+h[1])){var b=!0,c="value"in a?a.value:a.key;f.forEach(function(a){a&&a.length&&(b=2===a.length?b&&c[a[0]]===a[1]:b&&a[0].apply(D,[c]))});b&&(q++,
B.push(u(c)),n&&(c=s(c),a.update(c)));a["continue"]()}};return new Promise(function(a,b){z.oncomplete=function(){a(B)};z.onerror=function(a){b(a)};z.onabort=function(a){b(a)}})},d=function(a,b){var c="next",d="openCursor",h=[],f=null,g=I,e=!1,l=function(){return u(a,b,d,e?c+"unique":c,f,h,g)},p=function(){f=Array.prototype.slice.call(arguments,0,2);1==f.length&&f.unshift(0);return{execute:l}},q=function(){c=null;d="count";return{execute:l}},r=function(){d="openKeyCursor";return{desc:v,execute:l,filter:s,
distinct:w,map:t}},s=function(){h.push(Array.prototype.slice.call(arguments,0,2));return{keys:r,execute:l,filter:s,desc:v,distinct:w,modify:x,limit:p,map:t}},v=function(){c="prev";return{keys:r,execute:l,filter:s,distinct:w,modify:x,map:t}},w=function(){e=!0;return{keys:r,count:q,execute:l,filter:s,desc:v,modify:x,map:t}},x=function(a){n=a;return{execute:l}},t=function(a){g=a;return{execute:l,count:q,keys:r,filter:s,desc:v,distinct:w,modify:x,limit:p,map:t}};return{execute:l,count:q,keys:r,filter:s,
desc:v,distinct:w,modify:x,limit:p,map:t}};["only","bound","upperBound","lowerBound"].forEach(function(a){f[a]=function(){return new d(a,arguments)}});this.filter=function(){var a=new d(null,null);return a.filter.apply(a,arguments)};this.all=function(){return this.filter()}},G=function(b,e,g,f){b=b.target.result;g=new K(b,e);A[e]=b;return Promise.resolve(g)},A={},C={version:"0.9.2",open:function(b){var p;return new Promise(function(g,f){if(A[b.server])G({target:{result:A[b.server]}},b.server,b.version,
b.schema).then(g,f);else{if(!y&&(y=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB||(null===e.indexedDB&&e.shimIndexedDB?e.shimIndexedDB:D),!y))throw"IndexedDB required";p=y.open(b.server,b.version);p.onsuccess=function(e){G(e,b.server,b.version,b.schema).then(g,f)};p.onupgradeneeded=function(f){var e=b.schema,d=f.target.result;"function"===typeof e&&(e=e());for(var a in e){var g=e[a],c;c=!E.call(e,a)||d.objectStoreNames.contains(a)?f.currentTarget.transaction.objectStore(a):
d.createObjectStore(a,g.key);for(var m in g.indexes){var h=g.indexes[m];try{c.index(m)}catch(p){c.createIndex(m,h.key||m,Object.keys(h).length?h:{unique:!1})}}}};p.onerror=function(b){f(b)}}})}};"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=C:"function"===typeof define&&define.amd?define(function(){return C}):e.db=C})(window);
